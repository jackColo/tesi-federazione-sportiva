@if (user(); as u) {
<div class="max-w-4xl mx-auto space-y-6" [formGroup]="form">
  <div class="flex items-center gap-4">
    <a
      routerLink="../../"
      class="p-2 rounded-full hover:bg-slate-100 text-slate-500 transition-colors"
    >
      <fa-icon [icon]="icons.faArrowLeft"></fa-icon>
    </a>

    <div class="flex-1">
      <p class="text-slate-500 text-sm flex items-center gap-2 mt-1">
        <fa-icon [icon]="icons.faIdBadge" class="text-slate-400"></fa-icon>
        ID:
        <span
          class="font-mono text-xs bg-slate-100 border border-slate-200 px-2 py-0.5 rounded text-slate-600 select-all"
        >
          {{ u.id }}
        </span>
      </p>
    </div>

    <div class="ml-auto flex gap-2">
      @if (!isEditing) {
      <button
        (click)="toggleEdit()"
        class="btn-icon text-blue-600 bg-blue-50 hover:bg-blue-100 transition-colors p-2 rounded-lg"
        title="Modifica"
      >
        <fa-icon [icon]="icons.faPen"></fa-icon>
      </button>
      @if(isAdmin()) {
      <button
        (click)="delete.emit()"
        class="btn-icon text-red-600 bg-red-50 hover:bg-red-100 transition-colors p-2 rounded-lg"
        title="Elimina"
      >
        <fa-icon [icon]="icons.faTrash"></fa-icon>
      </button>
      } } @else {
      <button
        (click)="onSubmit()"
        [disabled]="form.invalid"
        class="btn-icon text-green-600 bg-green-50 hover:bg-green-100 transition-colors p-2 rounded-lg"
        title="Salva"
      >
        <fa-icon [icon]="icons.faCheck"></fa-icon>
      </button>
      <button
        (click)="cancelEdit()"
        class="btn-icon text-slate-600 bg-slate-100 hover:bg-slate-200 transition-colors p-2 rounded-lg"
        title="Annulla"
      >
        <fa-icon [icon]="icons.faTimes"></fa-icon>
      </button>
      }
    </div>
  </div>

  <div>
    <div class="flex flex-col sm:flex-row gap-3 mb-1 animate-in fade-in zoom-in-95 duration-200">
      <div class="flex-1 group">
        <label
          for="firstName"
          class="block text-[10px] font-bold uppercase text-slate-400 mb-1 tracking-wider pl-1"
        >
          Nome
        </label>
        <div class="relative">
          <input
            id="firstName"
            type="text"
            formControlName="firstName"
            class="w-full px-3 py-2 bg-white border border-slate-200 rounded-lg text-lg font-bold text-slate-800 shadow-sm focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all placeholder:text-slate-300"
            [placeholder]="u.firstName"
            [disabled]="!isEditing"
          />
          <div
            class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-slate-300 group-focus-within:text-blue-400"
          >
            <span class="text-xs font-mono">N</span>
          </div>
        </div>
      </div>

      <div class="flex-1 group">
        <label
          for="lastName"
          class="block text-[10px] font-bold uppercase text-slate-400 mb-1 tracking-wider pl-1"
        >
          Cognome
        </label>
        <div class="relative">
          <input
            id="lastName"
            type="text"
            formControlName="lastName"
            class="w-full px-3 py-2 bg-white border border-slate-200 rounded-lg text-lg font-bold text-slate-800 shadow-sm focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all placeholder:text-slate-300"
            [placeholder]="u.lastName"
            [disabled]="!isEditing"
          />
          <div
            class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-slate-300 group-focus-within:text-blue-400"
          >
            <span class="text-xs font-mono">C</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div
      class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-between"
    >
      <div class="flex items-center gap-3 mb-2">
        <div
          class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-500"
        >
          <fa-icon [icon]="icons.faEnvelope"></fa-icon>
        </div>
        <p class="text-sm text-slate-400 font-bold uppercase">Contatto</p>
      </div>
      @if (!isEditing) {
      <p class="text-sm font-bold text-slate-800 break-all">{{ u.email }}</p>
      } @else {
      <input
        type="email"
        formControlName="email"
        class="w-full px-2 py-1 border border-slate-300 rounded text-sm font-bold text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
      }
    </div>

    <div
      class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-between"
    >
      <div class="flex items-center gap-3 mb-2">
        <div
          class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-500"
        >
          <fa-icon [icon]="icons.faShieldAlt"></fa-icon>
        </div>
        <p class="text-sm text-slate-400 font-bold uppercase">Ruolo</p>
      </div>
      <div>
        <span
          class="px-3 py-1 rounded-full text-sm font-bold border border-transparent"
          [ngClass]="roleColorClass()"
        >
          {{ roleLabel() }}
        </span>
      </div>
    </div>

    @if (u.clubId) {
    <div
      class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-between"
    >
      <div class="flex items-center gap-3 mb-2">
        <div
          class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-500"
        >
          <fa-icon [icon]="icons.faBuilding"></fa-icon>
        </div>
        <p class="text-sm text-slate-400 font-bold uppercase">Club</p>
      </div>
      @if (!isEditing || (!isAdmin() && !isClubManager())) {
      <p class="text-sm text-slate-500">
        Società:
        <span class="text-sm font-bold text-slate-800 font-mono ml-2">
          @if(u.clubId && club()) { {{ club()?.name }} } @else { - }
        </span>
      </p>
      } @else if (!isAdmin()) {
      <select
        formControlName="clubId"
        class="w-full px-2 py-1 border border-slate-300 rounded text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
      >
        <option disabled [value]="''">Nessun Club</option>
        @for (c of availableClubs(); track c.id) {
        <option [value]="c.id">{{ c.name }}</option>
        }
      </select>
      }
    </div>
    }
  </div>

  @if(u.role === "ATHLETE") {
  <div
    class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 animate-in fade-in slide-in-from-top-2"
  >
    <div class="flex items-center gap-3 mb-6 border-b border-slate-100 pb-4">
      <div
        class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-500"
      >
        <fa-icon [icon]="icons.faUser"></fa-icon>
      </div>
      <div>
        <h3 class="font-bold text-slate-800">Dati Atleta</h3>
        <p class="text-xs text-slate-400">Informazioni fisiche e mediche.</p>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div>
        <label class="block text-[10px] font-bold uppercase text-slate-400 mb-1"
          >Data di Nascita</label
        >
        <input
          type="date"
          formControlName="birthDate"
          [class.border-red-500]="shouldShowError('birthDate')"
          [disabled]="!isEditing"
          class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm font-semibold text-slate-700 focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100"
        />
        @if (shouldShowError('birthDate')) {
        <p class="text-xs text-red-500 mt-1">{{ getErrorMessage('birthDate') }}</p>
        }
      </div>

      <div>
        <label class="block text-[10px] font-bold uppercase text-slate-400 mb-1">Peso (kg)</label>
        <div class="relative">
          <input
            type="number"
            formControlName="weight"
            placeholder="0.00"
          [disabled]="!isEditing"
            class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm font-semibold text-slate-700 focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100"
          />
          <span class="absolute right-3 top-2 text-xs text-slate-400 font-bold">KG</span>
        </div>
        @if (shouldShowError('weight')) {
        <p class="text-xs text-red-500 mt-1">{{ getErrorMessage('weight') }}</p>
        }
      </div>

      <div>
        <label class="block text-[10px] font-bold uppercase text-slate-400 mb-1"
          >Altezza (cm)</label
        >
        <div class="relative">
          <input
            type="number"
            formControlName="height"
            placeholder="0"
          [disabled]="!isEditing"
            class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm font-semibold text-slate-700 focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100"
          />
          <span class="absolute right-3 top-2 text-xs text-slate-400 font-bold">CM</span>
        </div>
        @if (shouldShowError('height')) {
        <p class="text-xs text-red-500 mt-1">{{ getErrorMessage('height') }}</p>
        }
      </div>

      <div class="md:col-span-2 lg:col-span-1">
        <label class="block text-[10px] font-bold uppercase text-slate-400 mb-1"
          >Nr. Certificato Medico</label
        >
        <input
          type="text"
          formControlName="medicalCertificateNumber"
          placeholder="Es. CM-2024-X89"
          [disabled]="!isEditing"
          class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm font-semibold text-slate-700 focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100"
        />
        @if (shouldShowError('medicalCertificateNumber')) {
        <p class="text-xs text-red-500 mt-1">{{ getErrorMessage('medicalCertificateNumber') }}</p>
        }
      </div>

      <div>
        <label class="block text-[10px] font-bold uppercase text-slate-400 mb-1"
          >Scadenza Certificato</label
        >
        <input
          type="date"
          formControlName="medicalCertificateExpireDate"
          [disabled]="!isEditing"
          class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm font-semibold text-slate-700 focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100"
        />
        @if (shouldShowError('medicalCertificateExpireDate')) {
        <p class="text-xs text-red-500 mt-1">
          {{ getErrorMessage('medicalCertificateExpireDate') }}
        </p>
        }
      </div>
    </div>
  </div>
  }

  <div class="bg-blue-50 rounded-xl border border-blue-100 p-6">
    <h3 class="font-bold text-blue-800 mb-2">Note Account</h3>
    <p class="text-sm text-blue-600">
      Questo utente ha privilegi di <strong>{{ roleLabel() }}</strong
      >. @if(isClubManager()) { È autorizzato a gestire iscrizioni e atleti per la società
      <span class="font-mono font-bold">{{ club()?.name }}</span
      >. } @else if(isAdmin()) { Ha accesso completo alla gestione della piattaforma federale. }
    </p>
  </div>
</div>
}
